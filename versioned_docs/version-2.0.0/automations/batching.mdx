---
sidebar_position: 8
sidebar_label: Batching
slug: ./batching
toc_max_heading_level: 2
---

import videoThumbnail from "./assets/video-thumbnail.png";
import creatingABatchUrl from "./assets/digests-batching-throttling/creating-a-batch.mp4";

# Batching (Beta)

Batching is a powerful feature of Courier Automations that aggregates events and processes them
collectively after a specified period of inactivity, a maximum event count, or a maximum wait time.
This is particularly useful in cases where a surge in activity produces an arbitrary number of events
over a short period.

## Use Cases

**Article Performance Summarization**

Imagine an article published on a news website that generates an event for each view, comment, and
share. Instead of sending a notification for each individual event, these events can be batched
within an automation. Once the initial surge of activity has subsided or the maximum wait time is
reached, the batch compiles view count, top comments, and share count data. This information is then
forwarded to the next step, allowing the author to receive a summarized report via email.

**Data Warehouse Analytics**

A company dealing with large amounts of data may produce a varying number of reports with different
completion times. An event is generated upon the completion of each report. With batching, these
reports can be grouped together and sent in a single email once all the reports for the day are
generated.

**Social Media Engagement**

Consider a user who creates a popular post that receives numerous likes within minutes of being
published. Instead of sending a notification for each like, batching can be employed to notify the
user once the post hasn't received new likes for a few minutes. For example, "Your post received 17
likes."

## Creating A Batch

To create a batch, use the "Add to Batch" action, then click anywhere within the batch node to open
the editor within the sidebar.

<video width="783" loop autoPlay muted controls poster={videoThumbnail}>
  <source src={creatingABatchUrl} />
</video>

When a batch node is invoked, Courier checks if there is an ongoing batch run for that node. If not,
Courier creates one, marks the automation as pending, and does not proceed to the next step until
the batch is complete.

If there _is_ an existing batch run, Courier will add the data object for that run to the existing
batch and terminate / complete the automation run. Any steps connected to the batch will not be
executed. This means the nodes following a batch node will only be executed once per batch run.

Once a batch is completed, the data objects are aggregated and passed onto the next step.

## Configuring A Batch

To configure a batch, click on the batch node to open an editor in the sidebar.

Batches have the following configuration options:

- Wait Period: Defines the period inactivity before a batch is considered complete. If no events are
  received within this time frame, the batch will be finalized and sent to the next step.
- Max Wait: Defines the maximum amount of time to wait before finalizing the batch. If this time
  frame is reached, the batch will immediately complete, even if an event had been receive within
  the "wait period".
- Retain Items: Defines the amount of items to be retained and sent along with the batch. Retention
  does not affect the tracked count. If retain is set to 10 items and 15 items are received, the
  passed count will be 15, and the passed items will be 10.
  - First 10: The first 10 items received will be included in the batch
  - Last 10: The last 10 items received will be included in the batch
  - Highest 10: The highest 10 items received will be included in the batch. When this option is
    selected, a sort key must also be provided.
  - Lowest 10: The lowest 10 items received will be included in the batch. When this option is
    selected, a sort key must also be provided.
- Sort Key: Required when Highest or Lowest is selected for Retain Items. Defines the key of the
  data object to be used to determine item ordering. For example, if sort key is set to upvotes, and
  the automation is invoked with `{ "data": { "upvotes": 5 } }`, 5 will be the value used to
  determine the order and position of the event in the items array.
- Max Items (Optional): Defines the maximum number of events to include in a batch before
  completion. When a batch has receive this number of events, it will immediately finalize and send
  the batch to the next step.
- Category Key (Optional): Defines the key the batch data will be attached to on the data object.
  See "Working with Multiple Categories" for more details.

## Working With Completed Batch Data

Once a batch run is completed, the batch will be added to the data object with the following
interface:

```typescript
{
  [category_key: string]: {
    // The number of events received for this category, may be different than items.length
    // depending on item retention configuration.
    count: number;
    // The an array of the data objects of each automation added to this batch.
    items: any[];
  }
}
```

By default, `category_key` is set to batch. To access the data from a batch in subsequent steps, use
refs.data.batch.count or `refs.data.batch.items`. If a `category_key` is specified, use that value
instead: `refs.data.<category_key value here>`. For example, if a batch was invoked 3 times with the
following values before completion:

```js
// Invoke 1
{
  data: {
    like_from: "Drew";
  }
}

// Invoke 2
{
  data: {
    like_from: "Alex";
  }
}

// Invoke 3
{
  data: {
    like_from: "Abby";
  }
}
```

The steps following the batch node would be provided this data object:

```js
{
  batch: {
    count: 3,
    items: [
      { like_from: "Drew" },
      { like_from: "Alex" },
      { like_from: "Abby" },
    ]
  }
}
```

This data can be accessed from a notification template using variable syntax. Because fields from
the data object are spread globally onto the template, there `refs.data` is omitted from within a
template:

<Image
  img={require("./assets/digests-batching-throttling/batch-data-in-notification-template.png")}
  alt="Accessing batch data from a notification template"
/>

### Working With Multiple Categories

It is possible to have more than one category in a single batch run if the category key is set to a
dynamic value such as `refs.data.category_key`. In such a case, each separate category can be
accessed separately on the data object.

<Image
  img={require("./assets/digests-batching-throttling/dynamic-category-key.png")}
  alt="Accessing
  batch data from a notification template"
/>

If the batch run was invoked with the following data:

```js
// Invoke 1
{
  data: {
    category_key: "likes",
    like_from: "Drew"
  }
}

// Invoke 2
{
  data: {
    category_key: "likes",
    like_from: "Alex"
  }
}

// Invoke 3
{
  data: {
    category_key: "comments"
    comment: "Excellent post!";
  }
}
```

The data object passed to the steps following the batch node would be:

```js
{
  likes: {
    count: 2,
    items: [
      { like_from: "Drew"; }
    ]
  }
}
```
