---
sidebar_position: 8
sidebar_label: Digests, Batching and Throttling
slug: ./digests-batching-throttling
toc_max_heading_level: 3
---

import videoThumbnail from "./assets/video-thumbnail.png";
import creatingABatchUrl from "./assets/digests-batching-throttling/creating-a-batch.mp4";

# Digests, Batching and Throttling (Beta)

## Batching

In Courier Automations, batching is the process of collecting events and pushing them to the next
step after a period of inactivity. This is especially useful in situations where a spike in activity
generates a large number of events over an arbitrary period of time. Batching groups those events
into a collection and passes them onto the next step after a period of inactivity, a maximum event
count has been reached, or a maximum period of time has been reached.

### Use Cases

**Article Performance Summarization**

An article is posted on a news site. An event is generated for each view, comment, and share of the
article. The author would not to receive a notification for each one of these events. Instead, these
events can be added to a batch within an automation. The post may generate a huge amount of events
within the first few days of posting. Once the activity has died down (or the max wait time has been
reached), the batch will collect the view count, top comments, and share count and send this data
to the next step. The user can then be sent a summary of this data in one email.

**Data Warehouse Analytics**

A company collects and processes a large amount of data. Reports on this data are constantly being
generated. The time to complete each report and/or the number of reports generated may vary from
day. An event is generated each time a report is completed. A batch can collect these reports and
send them in a single email once all the reports for that day have been generated.

**Social Media Engagement**

A user makes a popular post that receives a large number of likes in the first few minutes of being
posted. Rather than sending a notification for every like received, a batch can be used to notify
the user once the post hasn't received any new likes for a few minutes. E.g. You're post received
17 likes.

### Creating A Batch

To create a batch, use the "Add to Batch" action, then click anywhere within the batch node to
open the editor within the sidebar.

<video width="783" loop autoPlay muted controls poster={videoThumbnail}>
  <source src={creatingABatchUrl} />
</video>

When a batch node is invoked, Courier will check to see if there is an in progress batch run for that
node. If there _is not_ an existing run, Courier will create one. The automation will be marked as pending,
and will not move onto the next step until the batch is complete. The current data object is added
to the batch.

If there _is_ an existing batch run, Courier will add the data object for that run to the existing
batch and terminate / complete the automation run. Any steps connected to the batch will not be
executed. This means the nodes following a batch node will only be executed once per batch run.

### Configuring A Batch

To configure a batch, click on the batch node to open an editor in the sidebar.

Batches have the following configuration options:

- Wait Period: Defines the period inactivity before a batch is considered complete. If no events
  are received within this time frame, the batch will be finalized and sent to the next step.
-

### Working With Completed Batch Data

Once a batch run is completed, the batch will be added to the data object with the following
interface:

```typescript
{
  [category_key: string]: {
    // The number of events received for this category, may be different than items.length
    // depending on item retention configuration.
    count: number;
    // The an array of the data objects of each automation added to this batch.
    items: any[];
  }
}
```

By default, `category_key` is set to `batch`. So to access the data from a batch in steps following
the batch node, you would use `refs.data.batch.count` or `refs.data.batch.items`. If a category_key
is specified, you would use that value instead, `refs.data.<category_key value here>`.

For example, if a batch was invoked 3 times with the following values before completion:

```js
// Invoke 1
{
  data: {
    like_from: "Drew";
  }
}

// Invoke 2
{
  data: {
    like_from: "Alex";
  }
}

// Invoke 3
{
  data: {
    like_from: "Alex";
  }
}
```

The steps following the batch node would be provided this data object:

```
{
  batch: {
    count: 3,
    items: [
      { like_from: "Drew" },
      { like_from: "Alex" },
      { like_from: "Abby" },
    ]
  }
}
```

This data can be accessed from a notification template using variable syntax. Because fields
from the data object are spread globally onto the template, there `refs.data` is omitted from
within a template:

<Image
  img={require("./assets/digests-batching-throttling/batch-data-in-notification-template.png")}
  alt="Accessing batch data from a notification template"
/>

### Working With Multiple Categories

It is possible to have more than one category in a single batch run if the category key is set
to a dynamic value such as `refs.data.category_key`. In such a case, each separate category
can be accessed separately on the data object.

<Image
  img={require("./assets/digests-batching-throttling/dynamic-category-key.png")}
  alt="Accessing batch data from a notification template"
/>

If the batch run was invoked with the following data:

```js
// Invoke 1
{
  data: {
    category_key: "likes",
    like_from: "Drew"
  }
}

// Invoke 2
{
  data: {
    category_key: "likes",
    like_from: "Alex"
  }
}

// Invoke 3
{
  data: {
    category_key: "comments"
    comment: "Excellent post!";
  }
}
```

The data object passed to the steps following the batch node would be:

```js
{
  likes: {
    count: 2,
    items: [
      { like_from: "Drew"; }
    ]
  }
}
```
